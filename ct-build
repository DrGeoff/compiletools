#!/bin/bash
set -euo pipefail

# TODO: compile c source too. don't look in bindir, objdir for source files
all_exe_sources=$(find . -name '*.cpp' |xargs grep -l main\( | tr '\n' ' ')

test_dirs=$(find . -maxdepth 1 -type d -name 'test*' | tr '\n' ' ')
all_test_sources=""
for test_dir in $test_dirs; do
    all_test_sources+=$(find "$test_dir" -name 'test*cpp' | tr '\n' ' ')
done
cmd="ct-create-makefile ${all_exe_sources} ${all_test_sources} $@"
echo $cmd
$cmd

cpu_count=$(cat /proc/cpuinfo |grep processor | wc -l)
make -j$((2*cpu_count))

# Execute the tests
TESTPREFIX="timeout 300 valgrind --quiet --error-exitcode=1 "
if [[ -s test/valgrind_suppression.supp ]]; then
    TESTPREFIX+="--suppressions=test/valgrind_suppression.supp " 
fi

all_tests=$(find . -maxdepth 3 -type f -executable |grep test_ | tr '\n' ' ')
for atest in $all_tests; do
    echo "Testing $atest"
    $TESTPREFIX $atest
done


